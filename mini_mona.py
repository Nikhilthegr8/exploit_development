import pefile 
import os
import re 

def find_path_dll(dll,path):
    for root, dirs,files in os.walk(path):
        for i in files:
            if re.findall(dll,i,flags=re.IGNORECASE):
                return os.path.join(root,dll)


pe = pefile.PE('./putty.exe')
headers = ['DOS_HEADER','NT_HEADERS','FILE_HEADER','OPTIONAL_HEADER']

magic_number = pe.DOS_HEADER.e_magic
signature = pe.NT_HEADERS.Signature

print("Validating the whether its PE file or not ...")
if hex(magic_number) == '0x5a4d' and hex(signature) == '0x4550':
    print("Valid File")
else:
    print("Invalid File")


choice = int(input("""Enter your choice 
    1.List all imported DLL's 
    2.List all functions from a DLL
    3.List all functions from all DLL's
    4.List Number of Sections
    5.List All Sections in PE File
    6.List Security Mechanisms like ASLR , SEH NX etc
    100. to quit 
"""))

while choice!=100:
    if choice == 1:
        for i in pe.DIRECTORY_ENTRY_IMPORT:
            #print("\t%s at 0x%08x" % (i.name.decode('utf-8'), i.address))
            print(i.dll.decode('utf-8'))
    
    if choice==2:
        name = input("Enter dll name to search ")
        for i in pe.DIRECTORY_ENTRY_IMPORT:
            dll_name = i.dll.decode('utf-8')
            for j in i.imports:
                if dll_name == name:
                    print("\t%s at 0x%08x" % (j.name.decode('utf-8'), j.address))

    if choice==3:
        for i in pe.DIRECTORY_ENTRY_IMPORT:
            print(i.dll.decode('utf-8'))
            for j in i.imports:
                print("\t%s at 0x%08x" % (j.name.decode('utf-8'), j.address))
                
    if choice==4:
        print(pe.FILE_HEADER.NumberOfSections)

    if choice==5:
        for i in pe.sections:
            print(i)

    if choice==6:
        print("ASLR\t\tDEP\t\tSafeSEH\t\tControlFlowGuard\t\tHighEntropyVA")
        for j in pe.DIRECTORY_ENTRY_IMPORT:
            
            try:
                dll_name = j.dll.decode('utf-8')
                #print(dll_name)
                dll_path = find_path_dll(dll_name,'C:\\Windows\\System32')
                #print(dll_path)
                dll = pefile.PE(dll_path)

                print(str(dll.OPTIONAL_HEADER.IMAGE_DLLCHARACTERISTICS_DYNAMIC_BASE)+'\t\t',end='')
                print(str(dll.OPTIONAL_HEADER.IMAGE_DLLCHARACTERISTICS_NX_COMPAT)+'\t\t',end='')
                print(str(dll.OPTIONAL_HEADER.IMAGE_DLLCHARACTERISTICS_NO_SEH)+'\t\t',end='')
                print(str(dll.OPTIONAL_HEADER.IMAGE_DLLCHARACTERISTICS_GUARD_CF)+'\t\t',end='')
                print(str(dll.OPTIONAL_HEADER.IMAGE_DLLCHARACTERISTICS_HIGH_ENTROPY_VA)+'\t\t',end='')
                print(dll_name)
            except:
                pass


    choice = int(input("""Enter your choice 
    1.List all imported DLL's 
    2.List all functions from a DLL
    3.List all functions from all DLL's
    4.List Number of Sections
    5.List All Sections in PE File
    100. to quit 
    """))
